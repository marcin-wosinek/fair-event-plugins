name: Deploy to Acroyoga-Club.es

on:
    workflow_run:
        workflows: ['Continuous integration']
        types:
            - completed
        branches: [main]
    workflow_dispatch:
        inputs:
            plugins:
                description: 'Plugins to deploy (comma-separated, or "all")'
                required: false
                default: 'all'

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: acroyoga-club.es
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Create deployment status
              if: github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      // Create a commit status linking to this deployment
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        state: 'pending',
                        target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                        description: 'Deploying to acroyoga-club.es',
                        context: 'deploy/acroyoga-club.es'
                      });

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download build artifacts from CI
              if: github.event_name == 'workflow_run'
              uses: actions/download-artifact@v4
              with:
                  name: plugins
                  path: ./dist
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              uses: actions/setup-node@v3
              with:
                  node-version: '24'

            - name: Cache node_modules (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              id: npm-cache
              uses: actions/cache@v3
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

            - name: Build plugins (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              run: |
                  # Setup for manual deployment
                  if [ "${{ steps.npm-cache.outputs.cache-hit }}" != "true" ]; then
                    npm ci --prefer-offline
                  fi

                  # Install WP-CLI
                  curl -L -o wp-cli.phar https://github.com/wp-cli/wp-cli/releases/download/v2.12.0/wp-cli-2.12.0.phar
                  chmod +x wp-cli.phar
                  sudo mv wp-cli.phar /usr/local/bin/wp

                  # Install dist-archive command
                  wp package install git@github.com:wp-cli/dist-archive-command.git

                  # Install production PHP dependencies
                  npm run composer:install:prod

                  # Build JavaScript
                  npm run build

                  # Create distribution archives
                  npm run dist-archive

            - name: Extract plugin ZIPs
              run: |
                  mkdir -p extracted-plugins
                  cd dist
                  for zip in *.zip; do
                    if [ -f "$zip" ]; then
                      echo "Extracting $zip..."
                      unzip -q "$zip" -d ../extracted-plugins/
                    fi
                  done
                  cd ..
                  ls -la extracted-plugins/

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add SSH host key
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy plugins via rsync
              run: |
                  # Define plugins to deploy
                  PLUGINS_TO_DEPLOY="${{ github.event.inputs.plugins || 'all' }}"

                  if [ "$PLUGINS_TO_DEPLOY" = "all" ]; then
                    PLUGINS="fair-rsvp fair-events fair-payment fair-calendar-button fair-schedule fair-timetable fair-registration fair-membership fair-user-import fair-team"
                  else
                    PLUGINS="$PLUGINS_TO_DEPLOY"
                  fi

                  # Deploy each plugin from extracted directory
                  for plugin in $PLUGINS; do
                    if [ -d "extracted-plugins/$plugin" ]; then
                      echo "Deploying $plugin..."
                      rsync -avz --delete \
                        -e "ssh -p ${{ secrets.SSH_PORT }}" \
                        "extracted-plugins/$plugin/" \
                        "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.WORDPRESS_PLUGINS_PATH }}/$plugin/"

                      echo "✓ $plugin deployed successfully"
                    else
                      echo "⚠ $plugin directory not found in extracted-plugins/, skipping..."
                    fi
                  done

            - name: Post-deployment tasks
              run: |
                  echo "Deployment completed!"
                  echo "Deployed plugins: ${{ github.event.inputs.plugins || 'all' }}"
                  echo "Target: ${{ secrets.SSH_HOST }}"

            - name: Update deployment status - success
              if: success() && github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        state: 'success',
                        target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                        description: 'Deployed to acroyoga-club.es',
                        context: 'deploy/acroyoga-club.es'
                      });

            - name: Update deployment status - failure
              if: failure() && github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        state: 'failure',
                        target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                        description: 'Deployment failed',
                        context: 'deploy/acroyoga-club.es'
                      });

            - name: Comment on commit (workflow_run)
              if: always() && github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      const status = '${{ job.status }}';
                      const emoji = status === 'success' ? '✅' : '❌';
                      const message = status === 'success'
                        ? 'Deployment to acroyoga-club.es completed successfully'
                        : 'Deployment to acroyoga-club.es failed';

                      // Find existing commits to comment on
                      const commits = await github.rest.repos.listCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        per_page: 1
                      });

                      if (commits.data.length > 0) {
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: '${{ github.event.workflow_run.head_sha }}',
                          body: `${emoji} **${message}**\n\n[View deployment logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
                        });
                      }
