name: Deploy Fair Platform to fair-event-plugins.com

on:
    workflow_run:
        workflows: ['Continuous integration']
        types:
            - completed
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: fair-event-plugins.com
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Create deployment status
              if: github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      // Create a commit status linking to this deployment
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        state: 'pending',
                        target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                        description: 'Deploying fair-platform to fair-event-plugins.com',
                        context: 'deploy/fair-event-plugins.com'
                      });

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  # For workflow_run: use the ref from the triggering workflow
                  # For workflow_dispatch: use the ref from which the workflow was triggered (allows feature branch deployments)
                  ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

            - name: Show deployment info
              run: |
                  echo "Deployment Information:"
                  echo "  Trigger: ${{ github.event_name }}"
                  echo "  Branch: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}"
                  echo "  Commit: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}"
                  echo "  Actor: ${{ github.actor }}"

            - name: Download build artifacts from CI
              if: github.event_name == 'workflow_run'
              uses: actions/download-artifact@v4
              with:
                  name: plugins
                  path: ./dist
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              uses: actions/setup-node@v3
              with:
                  node-version: '24'

            - name: Cache root node_modules (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              id: npm-cache-root
              uses: actions/cache@v3
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-node-root-${{ hashFiles('package-lock.json') }}

            - name: Cache fair-platform node_modules (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              id: npm-cache-platform
              uses: actions/cache@v3
              with:
                  path: ./fair-platform/node_modules
                  key: ${{ runner.os }}-node-platform-${{ hashFiles('fair-platform/package-lock.json') }}

            - name: Build fair-platform plugin (manual dispatch only)
              if: github.event_name == 'workflow_dispatch'
              run: |
                  # Setup for manual deployment
                  if [ "${{ steps.npm-cache-root.outputs.cache-hit }}" != "true" ]; then
                    npm ci --prefer-offline
                  fi

                  # Install WP-CLI
                  curl -L -o wp-cli.phar https://github.com/wp-cli/wp-cli/releases/download/v2.12.0/wp-cli-2.12.0.phar
                  chmod +x wp-cli.phar
                  sudo mv wp-cli.phar /usr/local/bin/wp

                  # Install dist-archive command
                  wp package install git@github.com:wp-cli/dist-archive-command.git

                  # Build fair-platform React admin pages
                  cd fair-platform
                  if [ "${{ steps.npm-cache-platform.outputs.cache-hit }}" != "true" ]; then
                    npm install --prefer-offline
                  fi
                  npm run build
                  cd ..

                  # Install production PHP dependencies for fair-platform
                  cd fair-platform
                  composer install --no-dev
                  cd ..

                  # Create distribution archive for fair-platform only
                  npm run dist-archive:fair-platform

            - name: Extract fair-platform plugin
              run: |
                  mkdir -p extracted-plugins
                  cd dist

                  # Find fair-platform ZIP file (handles both fair-platform.zip and fair-platform.1.0.0.zip)
                  PLUGIN_ZIP=$(ls fair-platform*.zip 2>/dev/null | head -n 1)

                  if [ -n "$PLUGIN_ZIP" ]; then
                    echo "Found: $PLUGIN_ZIP"
                    echo "Extracting $PLUGIN_ZIP..."
                    unzip -q "$PLUGIN_ZIP" -d ../extracted-plugins/
                  else
                    echo "ERROR: fair-platform*.zip not found!"
                    echo "Available files in dist/:"
                    ls -la
                    exit 1
                  fi

                  cd ..
                  echo "Extracted contents:"
                  ls -la extracted-plugins/

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.FAIR_PLATFORM_SSH_KEY }}

            - name: Add SSH host key
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan -p ${{ vars.FAIR_PLATFORM_SSH_PORT }} -H ${{ vars.FAIR_PLATFORM_SSH_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy fair-platform plugin via rsync
              run: |
                  echo "Deploying fair-platform to fair-event-plugins.com..."
                  rsync -avz --delete \
                    -e "ssh -p ${{ vars.FAIR_PLATFORM_SSH_PORT }}" \
                    "extracted-plugins/fair-platform/" \
                    "${{ vars.FAIR_PLATFORM_SSH_USER }}@${{ vars.FAIR_PLATFORM_SSH_HOST }}:${{ vars.FAIR_PLATFORM_PLUGINS_PATH }}/fair-platform/"

                  echo "✓ fair-platform deployed successfully"

            - name: Post-deployment tasks
              run: |
                  echo "✓ Deployment completed!"
                  echo "  Plugin: fair-platform"
                  echo "  Target: ${{ vars.FAIR_PLATFORM_SSH_HOST }}"
                  echo "  Branch: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}"
                  echo "  Commit: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}"

            - name: Update deployment status - success
              if: success() && github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        state: 'success',
                        target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                        description: 'Deployed fair-platform to fair-event-plugins.com',
                        context: 'deploy/fair-event-plugins.com'
                      });

            - name: Update deployment status - failure
              if: failure() && github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        state: 'failure',
                        target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                        description: 'Deployment of fair-platform failed',
                        context: 'deploy/fair-event-plugins.com'
                      });

            - name: Comment on commit (workflow_run)
              if: always() && github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      const status = '${{ job.status }}';
                      const emoji = status === 'success' ? '✅' : '❌';
                      const message = status === 'success'
                        ? 'Deployed fair-platform to fair-event-plugins.com successfully'
                        : 'Deployment of fair-platform to fair-event-plugins.com failed';

                      // Find existing commits to comment on
                      const commits = await github.rest.repos.listCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.workflow_run.head_sha }}',
                        per_page: 1
                      });

                      if (commits.data.length > 0) {
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: '${{ github.event.workflow_run.head_sha }}',
                          body: `${emoji} **${message}**\n\n[View deployment logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
                        });
                      }

            - name: Comment on commit (workflow_dispatch)
              if: always() && github.event_name == 'workflow_dispatch'
              uses: actions/github-script@v7
              with:
                  script: |
                      const status = '${{ job.status }}';
                      const emoji = status === 'success' ? '✅' : '❌';
                      const branch = '${{ github.ref_name }}';
                      const message = status === 'success'
                        ? `Manually deployed fair-platform to fair-event-plugins.com from branch \`${branch}\``
                        : `Manual deployment of fair-platform to fair-event-plugins.com failed (from branch \`${branch}\`)`;

                      await github.rest.repos.createCommitComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        commit_sha: '${{ github.sha }}',
                        body: `${emoji} **${message}**\n\nTriggered by: @${{ github.actor }}\n\n[View deployment logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
                      });
