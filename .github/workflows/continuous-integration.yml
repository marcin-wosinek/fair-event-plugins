name: Continuous integration

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            environment:
                description: 'Environment to deploy to'
                required: true
                type: choice
                options:
                    - acroyoga-club.es
                    - fair-event-plugins.com
                    - lamutable.es
                    - fusion-dance.es
                    - acro-agenda.es
                    - all

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2'
                  extensions: mbstring, intl, zip
                  coverage: none

            - name: Validate composer.json for all plugins
              run: |
                  npm run composer:validate

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v3
              with:
                  path: |
                      ./fair-payment/vendor
                      ./fair-events/vendor
                      ./fair-platform/vendor
                      ./fair-audience/vendor
                      ./vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '24'

            - name: Cache node_modules
              id: npm-cache
              uses: actions/cache@v3
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

            - name: Install npm dependencies
              if: steps.npm-cache.outputs.cache-hit != 'true'
              run: npm ci --prefer-offline

            - name: Install WP-CLI
              run: |
                  curl -L -o wp-cli.phar https://github.com/wp-cli/wp-cli/releases/download/v2.12.0/wp-cli-2.12.0.phar
                  chmod +x wp-cli.phar
                  sudo mv wp-cli.phar /usr/local/bin/wp
                  wp --info

            - name: Install WP-CLI dist-archive command
              run: |
                  wp package install wp-cli/dist-archive-command
                  wp package list
                  wp dist-archive --help

            - name: Install regular PHP dependencies in all plugins
              run: npm run composer:install:prod

            - name: Build JavaScript for all plugins
              run: npm run build

            - name: Create plugin ZIP files using wp dist-archive
              run: |
                  npm run dist-archive
                  echo "Contents of dist directory:"
                  ls -lah ./dist/ || echo "dist directory not found"

            - name: Install dev PHP dependencies in all plugins
              run: npm run composer:install

            - name: Run unit tests
              run: |
                  npm test

            - name: Upload plugins
              uses: actions/upload-artifact@v4
              with:
                  name: plugins
                  path: ./dist/*.zip
                  retention-days: 7
                  if-no-files-found: error

    release:
        name: Release
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '24'

            - name: Cache node_modules
              id: npm-cache
              uses: actions/cache@v3
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

            - name: Install Dependencies
              if: steps.npm-cache.outputs.cache-hit != 'true'
              run: HUSKY=0 npm ci --prefer-offline

            - name: Create Release Pull Request
              uses: changesets/action@v1
              with:
                  version: npm run version-packages
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    deploy-acroyoga:
        name: Deploy to acroyoga-club.es
        needs: [build]
        if: |
            (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
            (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'acroyoga-club.es' || github.event.inputs.environment == 'all'))
        uses: ./.github/workflows/deploy-to-environment.yml
        with:
            environment: acroyoga-club.es
        secrets: inherit

    deploy-fair-event-plugins:
        name: Deploy to fair-event-plugins.com
        needs: [build]
        if: |
            (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
            (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'fair-event-plugins.com' || github.event.inputs.environment == 'all'))
        uses: ./.github/workflows/deploy-to-environment.yml
        with:
            environment: fair-event-plugins.com
        secrets: inherit

    deploy-lamutable:
        name: Deploy to lamutable.es
        needs: [build]
        if: |
            (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
            (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'lamutable.es' || github.event.inputs.environment == 'all'))
        uses: ./.github/workflows/deploy-to-environment.yml
        with:
            environment: lamutable.es
        secrets: inherit

    deploy-fusion-dance:
        name: Deploy to fusion-dance.es
        needs: [build]
        if: |
            (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
            (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'fusion-dance.es' || github.event.inputs.environment == 'all'))
        uses: ./.github/workflows/deploy-to-environment.yml
        with:
            environment: fusion-dance.es
        secrets: inherit

    deploy-acro-agenda:
        name: Deploy to acro-agenda.es
        needs: [build]
        if: |
            (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
            (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'acro-agenda.es' || github.event.inputs.environment == 'all'))
        uses: ./.github/workflows/deploy-to-environment.yml
        with:
            environment: acro-agenda.es
        secrets: inherit
