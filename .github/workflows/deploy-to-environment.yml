name: Deploy to Environment

on:
    workflow_call:
        inputs:
            environment:
                description: 'Environment to deploy to'
                required: true
                type: string

jobs:
    deploy:
        name: Deploy to ${{ inputs.environment }}
        runs-on: ubuntu-latest
        environment: ${{ inputs.environment }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: plugins
                  path: ./dist

            - name: Extract plugin ZIPs
              run: |
                  mkdir -p extracted-plugins
                  cd dist
                  for zip in *.zip; do
                    if [ -f "$zip" ]; then
                      echo "Extracting $zip..."
                      unzip -q "$zip" -d ../extracted-plugins/
                    fi
                  done
                  cd ..
                  ls -la extracted-plugins/

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add SSH host key
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan -p ${{ vars.SSH_PORT }} -H ${{ vars.SSH_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy plugins via rsync
              run: |
                  # Get plugins to deploy from environment variable
                  PLUGINS_TO_DEPLOY="${{ vars.PLUGINS_TO_DEPLOY }}"

                  if [ -z "$PLUGINS_TO_DEPLOY" ]; then
                    echo "ERROR: PLUGINS_TO_DEPLOY variable not set for environment ${{ inputs.environment }}"
                    exit 1
                  fi

                  if [ "$PLUGINS_TO_DEPLOY" = "all" ]; then
                    PLUGINS="fair-rsvp fair-events fair-payment fair-calendar-button fair-schedule fair-timetable fair-registration fair-membership fair-user-import fair-team fair-audience"
                  else
                    # Convert comma-separated list to space-separated
                    PLUGINS=$(echo "$PLUGINS_TO_DEPLOY" | tr ',' ' ')
                  fi

                  echo "Deploying plugins: $PLUGINS"
                  echo ""

                  # Deploy each plugin from extracted directory
                  DEPLOYED_COUNT=0
                  SKIPPED_COUNT=0

                  for plugin in $PLUGINS; do
                    if [ -d "extracted-plugins/$plugin" ]; then
                      echo "Deploying $plugin..."
                      rsync -avz --delete \
                        -e "ssh -p ${{ vars.SSH_PORT }}" \
                        "extracted-plugins/$plugin/" \
                        "${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:${{ vars.WORDPRESS_PLUGINS_PATH }}/$plugin/"

                      echo "✓ $plugin deployed successfully"
                      echo ""
                      DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
                    else
                      echo "⚠ $plugin directory not found in extracted-plugins/, skipping..."
                      echo ""
                      SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                    fi
                  done

                  echo "========================================="
                  echo "Deployment Summary:"
                  echo "  Deployed: $DEPLOYED_COUNT plugin(s)"
                  echo "  Skipped: $SKIPPED_COUNT plugin(s)"
                  echo "  Target: ${{ vars.SSH_HOST }}"
                  echo "========================================="
