name: Continuous integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, intl, zip
          coverage: none

      - name: Validate composer.json for all plugins
        run: |
          composer validate --strict --working-dir=./fair-calendar-button
          composer validate --strict --working-dir=./fair-payment
          composer validate --strict --working-dir=./fair-registration
          composer validate --strict --working-dir=./fair-timetable

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: |
            ./fair-calendar-button/vendor
            ./fair-payment/vendor
            ./fair-registration/vendor
            ./fair-timetable/vendor
            ./vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install npm dependencies
        run: npm ci

      - name: Install PHP dependencies in all plugins
        run: npm run composer

      - name: Build JavaScript for all plugins
        run: npm run build

      - name: Run unit tests
        run: |
          npm test

      - name: Install WP-CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/wp-cli/v2.10.0/utils/wp-completion.bash
          curl -O https://github.com/wp-cli/wp-cli/releases/download/v2.10.0/wp-cli-2.10.0.phar
          chmod +x wp-cli-2.10.0.phar
          sudo mv wp-cli-2.10.0.phar /usr/local/bin/wp

      - name: Install WP-CLI dist-archive command
        run: |
          wp package install wp-cli/dist-archive-command:@stable

      - name: Create plugin ZIP files using wp dist-archive
        run: |
          npm run dist-archive

      - name: Upload Fair Payment plugins
        uses: actions/upload-artifact@v4
        with:
          name: plugins
          path: ./dist/
          retention-days: 7
