name: Continuous integration

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    # Call the centralized build workflow
    build:
        uses: ./.github/workflows/build.yml

    # Run tests using dev dependencies
    test:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - uses: actions/checkout@v3

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2'
                  extensions: mbstring, intl, zip
                  coverage: none

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v3
              with:
                  path: |
                      ./fair-calendar-button/vendor
                      ./fair-payment/vendor
                      ./fair-registration/vendor
                      ./fair-schedule-blocks/vendor
                      ./fair-timetable/vendor
                      ./fair-membership/vendor
                      ./fair-events/vendor
                      ./fair-rsvp/vendor
                      ./fair-platform/vendor
                      ./vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '24'

            - name: Cache node_modules
              id: npm-cache
              uses: actions/cache@v3
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

            - name: Install npm dependencies
              if: steps.npm-cache.outputs.cache-hit != 'true'
              run: npm ci --prefer-offline

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: plugins-${{ github.sha }}
                  path: ./dist

            - name: Extract built JavaScript from artifacts
              run: |
                  # Extract build directories from the plugin ZIPs
                  for plugin in fair-calendar-button fair-payment fair-registration fair-schedule-blocks fair-timetable fair-membership fair-events fair-rsvp fair-platform fair-user-import; do
                    if [ -f "dist/${plugin}.zip" ] || [ -f "dist/${plugin}."*".zip" ]; then
                      echo "Extracting build directory from ${plugin}..."
                      # Find the ZIP file (handles both versioned and unversioned names)
                      ZIP_FILE=$(ls dist/${plugin}*.zip 2>/dev/null | head -n 1)
                      if [ -n "$ZIP_FILE" ]; then
                        # Extract only the build directory
                        unzip -q "$ZIP_FILE" "${plugin}/build/*" -d temp/ 2>/dev/null || true
                        # Copy to the source directory
                        if [ -d "temp/${plugin}/build" ]; then
                          mkdir -p "${plugin}/build"
                          cp -r temp/${plugin}/build/* "${plugin}/build/"
                          echo "âœ“ ${plugin}/build extracted"
                        fi
                      fi
                    fi
                  done
                  rm -rf temp/

            - name: Install dev PHP dependencies in all plugins
              run: npm run composer:install

            - name: Run unit tests
              run: |
                  npm test
